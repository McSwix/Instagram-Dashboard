<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#f0f2f5" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>" />
  <title>History â€” IG Dashboard</title>
  <link rel="stylesheet" href="styles/main.css" />
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <style>
    .history-summary {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-bottom: 2rem;
    }
    @media (max-width: 640px) { .history-summary { grid-template-columns: 1fr; } }

    .summary-card {
      padding: 1.25rem;
      text-align: center;
    }

    .timeline-card {
      padding: 1rem 1.25rem;
      margin-bottom: 0;
    }

    .timeline-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .timeline-time {
      font-size: 0.8125rem;
      font-weight: 600;
    }

    .timeline-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }
    .timeline-meta span {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .timeline-error {
      margin-top: 0.5rem;
      font-size: 0.75rem;
      color: var(--color-negative);
      background: #fee2e2;
      padding: 0.4rem 0.75rem;
      border-radius: var(--radius-sm);
    }

    .empty-history {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }
  </style>
</head>
<body>

  <div class="page-container page-content" id="page">

    <h1 class="section-title animate-in stagger-1" style="margin-bottom:1.5rem;">Sync History</h1>

    <!-- Summary -->
    <div id="summary-area" class="animate-in stagger-2">
      <!-- filled by JS -->
    </div>

    <!-- Timeline -->
    <div id="timeline-area" class="animate-in stagger-3">
      <!-- filled by JS -->
    </div>

  </div>

  <script src="js/firestore-store.js"></script>
  <script src="js/instagram-api.js"></script>
  <script src="js/components.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      Nav.inject('history');
      PageTransition.init();
      await PasswordModal.show();

      try { Store.init(); } catch (e) { ToastManager.error('Firebase Error', e.message); return; }
      TokenWarning.check();

      // Skeletons
      document.getElementById('summary-area').innerHTML = `
        <div class="history-summary">${Skeleton.card(3)}</div>
      `;
      document.getElementById('timeline-area').innerHTML = Skeleton.timeline(5);

      await loadHistory();
      AutoSync.run();
    });

    async function loadHistory() {
      const summaryArea = document.getElementById('summary-area');
      const timelineArea = document.getElementById('timeline-area');

      try {
        const syncs = await Store.getRecentSyncs(200);

        if (!syncs.length) {
          summaryArea.innerHTML = '';
          timelineArea.innerHTML = `
            <div class="empty-history">
              <div style="font-size:2.5rem;margin-bottom:1rem;">&#128340;</div>
              <div style="font-size:1rem;font-weight:600;margin-bottom:0.5rem;">No sync history yet</div>
              <div style="font-size:0.875rem;">Go to <a href="settings.html" style="color:var(--accent);text-decoration:underline;">Settings</a> to run your first sync or upload data.</div>
            </div>
          `;
          return;
        }

        // Summary stats
        const firstSync = syncs[syncs.length - 1];
        const latestSync = syncs[0];
        const apiCount = syncs.filter(s => s.type === 'api').length;
        const uploadCount = syncs.filter(s => s.type === 'manual_upload').length;

        summaryArea.innerHTML = `
          <div class="history-summary">
            <div class="glass-card summary-card">
              <div class="metric-label">Total Syncs</div>
              <div class="metric-value" data-counter="${syncs.length}">0</div>
              <div style="font-size:0.6875rem;color:var(--text-tertiary);margin-top:0.25rem;">
                ${apiCount} API &bull; ${uploadCount} uploads
              </div>
            </div>
            <div class="glass-card summary-card">
              <div class="metric-label">First Sync</div>
              <div style="font-family:var(--font-display);font-size:1.125rem;font-weight:700;margin-top:0.25rem;">
                ${Utils.formatDate(firstSync.timestamp)}
              </div>
            </div>
            <div class="glass-card summary-card">
              <div class="metric-label">Latest Sync</div>
              <div style="font-family:var(--font-display);font-size:1.125rem;font-weight:700;margin-top:0.25rem;">
                ${Utils.formatDateTime(latestSync.timestamp)}
              </div>
            </div>
          </div>
        `;

        // Timeline
        timelineArea.innerHTML = `
          <div class="timeline">
            ${syncs.map((sync, i) => {
              const isLatest = i === 0;
              const isApi = sync.type === 'api';
              const dotClass = isApi ? 'api' : 'upload';

              const statusBadge = sync.status === 'success'
                ? '<span class="badge badge-success">Success</span>'
                : sync.status === 'partial'
                ? '<span class="badge badge-warning">Partial</span>'
                : '<span class="badge badge-error">Error</span>';

              const typeBadge = isApi
                ? '<span class="badge badge-info">API Sync</span>'
                : '<span class="badge" style="background:#fce7f3;color:#db2777;">Upload</span>';

              let metaHtml = '';

              if (sync.followerCount != null) {
                metaHtml += `<span>&#128101; ${Utils.formatNumber(sync.followerCount)} followers</span>`;
              }
              if (sync.followingCount != null) {
                metaHtml += `<span>&#128100; ${Utils.formatNumber(sync.followingCount)} following</span>`;
              }
              if (sync.postsProcessed) {
                metaHtml += `<span>&#128247; ${sync.postsProcessed} posts</span>`;
              }
              if (sync.apiCallsUsed) {
                metaHtml += `<span>&#9889; ${sync.apiCallsUsed} API calls</span>`;
              }

              const errorHtml = sync.errorMessage
                ? `<div class="timeline-error">${Utils.escapeHtml(sync.errorMessage)}</div>`
                : '';

              return `
                <div class="timeline-item ${isLatest ? 'latest' : ''}">
                  <div class="timeline-dot ${dotClass}"></div>
                  <div class="glass-card${isLatest ? '' : '-static'} timeline-card">
                    <div class="timeline-header">
                      <div class="timeline-time">${Utils.formatDateTime(sync.timestamp)}</div>
                      <div class="flex gap-1" style="gap:0.4rem;">${typeBadge} ${statusBadge}</div>
                    </div>
                    <div class="timeline-meta">${metaHtml}</div>
                    ${errorHtml}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;

        AnimatedCounter.observeAll();
      } catch (e) {
        timelineArea.innerHTML = `<div class="empty-history">Error loading history: ${e.message}</div>`;
      }
    }
  </script>

</body>
</html>
